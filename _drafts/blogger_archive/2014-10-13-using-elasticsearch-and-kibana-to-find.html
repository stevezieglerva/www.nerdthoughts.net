---
layout: post
title: Using Elasticsearch and Kibana To Find Files To Free Up Disk Space
date: '2014-10-13T00:40:00.003-04:00'
author: Stephen Ziegler
tags: 
modified_time: '2014-10-13T00:40:19.251-04:00'
thumbnail: http://3.bp.blogspot.com/-i2Daeyya_zY/VDtDLyiHZDI/AAAAAAAAg7s/x8KVgRqEs5k/s72-c/disk_space.png
blogger_id: tag:blogger.com,1999:blog-1727955271917225446.post-1581103025859802992
blogger_orig_url: http://www.nerdthoughts.net/2014/10/using-elasticsearch-and-kibana-to-find.html
---

<div class="separator" style="clear: both; text-align: left;">My hard drive constantly looks like this:</div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;"><a href="http://3.bp.blogspot.com/-i2Daeyya_zY/VDtDLyiHZDI/AAAAAAAAg7s/x8KVgRqEs5k/s1600/disk_space.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-i2Daeyya_zY/VDtDLyiHZDI/AAAAAAAAg7s/x8KVgRqEs5k/s1600/disk_space.png" /></a></div><br /><div>I'm frequently running out of space and I've never had a good handle on what's taking up all of the space. Over the years, I've created a few simple batch processes with DOS and AWK to parse <i>dir </i>command output and highlight large files. But, those processes didn't give me the big picture of where the most space is taken up, especially due to a large number of files (not just a single huge file).</div><div><br /></div><div>This weekend, I realized that I could re-use some of that batch processing to index data in Elasticsearch and visualize it with Kibana. With the smart use of directory parsing, the faceting of Kibana will allow me to quickly navigate large chunks of my directory structure.</div><div><br /><h3>Get directories</h3></div><div>The first step is to use DOS to parse out directory&nbsp;listings. It's a really easy way to recursively get all file data across the hard drive.</div><div><pre style="background: #ffffff; color: black;"><html><body style="background: #ffffff; color: black;"><pre><br />dir <span style="color: #808030;">/</span>s c<span style="color: purple;">:</span>\<span style="color: #808030;">*</span><span style="color: #808030;">.</span><span style="color: #808030;">*</span> <span style="color: #808030;">&gt;</span> dir_listing<span style="color: #808030;">.</span>txt<br /></pre></body></html></pre></div><div><br /></div><div>That creates data like this: </div><div><pre style="background: #ffffff; color: black;"><html><body style="background: #ffffff; color: black;"><pre><br />Volume <span style="color: maroon; font-weight: bold;">in</span> drive C is OS<br /> Volume Serial <span style="color: #797997;">Number</span> is E415<br /><br /> Directory of c<span style="color: purple;">:</span>\<br /><br /><span style="color: #008c00;">06</span><span style="color: #808030;">/</span><span style="color: #008c00;">05</span><span style="color: #808030;">/</span><span style="color: #008c00;">2014</span>  <span style="color: #008c00;">06</span><span style="color: purple;">:</span><span style="color: #008c00;">53</span> AM             <span style="color: #008c00;">1</span><span style="color: #808030;">,</span><span style="color: #008c00;">024</span> <span style="color: #808030;">.</span>rnd<br /><span style="color: #008c00;">06</span><span style="color: #808030;">/</span><span style="color: #008c00;">05</span><span style="color: #808030;">/</span><span style="color: #008c00;">2014</span>  <span style="color: #008c00;">06</span><span style="color: purple;">:</span><span style="color: #008c00;">47</span> AM    <span style="color: #808030;">&lt;</span>DIR<span style="color: #808030;">&gt;</span>          Bitnami<br /><span style="color: #008c00;">11</span><span style="color: #808030;">/</span><span style="color: #008c00;">23</span><span style="color: #808030;">/</span><span style="color: #008c00;">2011</span>  <span style="color: #008c00;">09</span><span style="color: purple;">:</span><span style="color: #008c00;">39</span> AM               <span style="color: #008c00;">512</span> BOOT_SAV<span style="color: #808030;">.</span>BOT<br /><span style="color: #008c00;">12</span><span style="color: #808030;">/</span><span style="color: #008c00;">27</span><span style="color: #808030;">/</span><span style="color: #008c00;">2013</span>  <span style="color: #008c00;">01</span><span style="color: purple;">:</span><span style="color: #008c00;">00</span> PM    <span style="color: #808030;">&lt;</span>DIR<span style="color: #808030;">&gt;</span>          c0436b1b47be35de36<br /><span style="color: #008c00;">02</span><span style="color: #808030;">/</span><span style="color: #008c00;">07</span><span style="color: #808030;">/</span><span style="color: #008c00;">2014</span>  <span style="color: #008c00;">02</span><span style="color: purple;">:</span><span style="color: #008c00;">02</span> AM    <span style="color: #808030;">&lt;</span>DIR<span style="color: #808030;">&gt;</span>          c929fb44de733fa3c300<br /><span style="color: #008c00;">12</span><span style="color: #808030;">/</span><span style="color: #008c00;">27</span><span style="color: #808030;">/</span><span style="color: #008c00;">1999</span>  <span style="color: #008c00;">12</span><span style="color: purple;">:</span><span style="color: #008c00;">25</span> PM             <span style="color: #008c00;">2</span><span style="color: #808030;">,</span><span style="color: #008c00;">238</span> clock<span style="color: #808030;">.</span>ico<br /><span style="color: #008c00;">05</span><span style="color: #808030;">/</span><span style="color: #008c00;">12</span><span style="color: #808030;">/</span><span style="color: #008c00;">2014</span>  <span style="color: #008c00;">01</span><span style="color: purple;">:</span><span style="color: #008c00;">22</span> PM    <span style="color: #808030;">&lt;</span>DIR<span style="color: #808030;">&gt;</span>          CRM <span style="color: #008c00;">2013</span><br /><span style="color: #008c00;">11</span><span style="color: #808030;">/</span><span style="color: #008c00;">07</span><span style="color: #808030;">/</span><span style="color: #008c00;">2012</span>  <span style="color: #008c00;">11</span><span style="color: purple;">:</span><span style="color: #008c00;">18</span> AM             <span style="color: #008c00;">9</span><span style="color: #808030;">,</span><span style="color: #008c00;">729</span> default<span style="color: #808030;">.</span>csv<br /><span style="color: #008c00;">11</span><span style="color: #808030;">/</span><span style="color: #008c00;">07</span><span style="color: #808030;">/</span><span style="color: #008c00;">2007</span>  <span style="color: #008c00;">09</span><span style="color: purple;">:</span><span style="color: #008c00;">00</span> AM            <span style="color: #008c00;">17</span><span style="color: #808030;">,</span><span style="color: #008c00;">734</span> eula<span style="color: #808030;">.</span><span style="color: green;">1028.</span>txt<br /><span style="color: #008c00;">11</span><span style="color: #808030;">/</span><span style="color: #008c00;">07</span><span style="color: #808030;">/</span><span style="color: #008c00;">2007</span>  <span style="color: #008c00;">09</span><span style="color: purple;">:</span><span style="color: #008c00;">00</span> AM            <span style="color: #008c00;">17</span><span style="color: #808030;">,</span><span style="color: #008c00;">734</span> eula<span style="color: #808030;">.</span><span style="color: green;">1031.</span>txt<br /></pre></body></html></pre></div><div><br /></div><div><br /></div><div>I then use AWK to parse out up to 10 of the first directory names into specific fields (folder1, folder2, ...) and also parse out the parent directory of the current file. I also do some typical field splitting to help with possible future aggregations and faceting. I store the file extension (.txt, .pdf, ...) and date parts (10, 12, 2014) into separate fields. The tab delimited file looks like this:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/--_jczlq52ME/VDtKNP4-DqI/AAAAAAAAg78/yjzKAJeswCE/s1600/excel%2Bdir%2Blisting.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/--_jczlq52ME/VDtKNP4-DqI/AAAAAAAAg78/yjzKAJeswCE/s1600/excel%2Bdir%2Blisting.png" /></a></div></div><div><br /><br /><h3>Index</h3>I run another AWK script to format it into Elasticsearch's bulk format so it can be loaded quickly. I format the date into the typical Kibana <i>@timestamp</i> field so I can easily slice by date.&nbsp;I have about 330,000 files and the entire process takes about 10 minutes. I also added another 600,000 files from a backup drive. The index takes up 418 Mbs.<br /><br /><div class="separator" style="clear: both; text-align: left;"><a href="http://4.bp.blogspot.com/-bnAfLZLd2ss/VDtOiO0oCYI/AAAAAAAAg8I/Pl3ATRxTfYw/s1600/elastic%2Bhead.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-bnAfLZLd2ss/VDtOiO0oCYI/AAAAAAAAg8I/Pl3ATRxTfYw/s1600/elastic%2Bhead.png" height="178" width="400" /></a></div><br /><br /><h3>Visualize</h3>The fun part is setting up a Kibana dashboard to visualize the data. In the first row, I add a typical <i>Terms </i>count on the document types. This is a good health check of the index, especially when loading data.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-xn8ZCJYbPNc/VDtQGOgQEYI/AAAAAAAAg8U/_AlZEvIQV_s/s1600/kibana%2B1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-xn8ZCJYbPNc/VDtQGOgQEYI/AAAAAAAAg8U/_AlZEvIQV_s/s1600/kibana%2B1.png" height="332" width="640" /></a></div><br />I then add some pie charts with&nbsp;<i>Terms Stats&nbsp;</i>showing the biggest root directories off of c:\ (c:\windows, c:\users, c:\temp), the biggest files, and the biggest directories. These are simple Terms panels using Terms Stats based on a field (folder1, file, or parent) based on the pie chart. I use some field templating to automatically store the raw version of the field in case the directory name was parsed into multiple tokens.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-hzictvVNNac/VDtRXxyq9UI/AAAAAAAAg8g/gqA8cRuKgs8/s1600/kibana%2B2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-hzictvVNNac/VDtRXxyq9UI/AAAAAAAAg8g/gqA8cRuKgs8/s1600/kibana%2B2.png" height="216" width="640" /></a></div><br />The first pie chart shows me that 39% of the hard drive is off limits for deletions since it's the Windows folder. The second pie chart shows that my Outlook mail file is huge! The third pie chart shows that a decent amount of disk space is taken up in my Outlook and index folders. The index folder is for Elasticsearch: a large amount of space, but well worth the bits.<br /><br />In the second row, I show the same biggest files and dirs data, but in table format. This view allows me to show the raw <i>bytes </i>field with the nice thousands comma separator.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-WVmjFWJ_zp0/VDtSzKUXbQI/AAAAAAAAg8s/8L2qRQSJlzo/s1600/kibana%2B3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-WVmjFWJ_zp0/VDtSzKUXbQI/AAAAAAAAg8s/8L2qRQSJlzo/s1600/kibana%2B3.png" height="280" width="640" /></a></div><br />Finally, the really helpful panels to navigate and find large amounts of data in directories are the&nbsp;<i>Terms Stats</i> panels based on the parsed folder names.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-I4Krtrxe05E/VDtTfNz8wII/AAAAAAAAg80/MHBqMVMzb4o/s1600/kibana%2B4.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-I4Krtrxe05E/VDtTfNz8wII/AAAAAAAAg80/MHBqMVMzb4o/s1600/kibana%2B4.png" height="216" width="640" /></a></div><br />Each panel aggregates the number of bytes of files within that branch of the directory tree. Since I parsed out the top folder names before indexing, it acts like a recursive aggregation down the directory branch. It's a combination of a data warehousing de-normlization step along with field parsing for full text search. It's super fast and automatically adjusts all of the other facets on the page.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-WEpHZBAbGDg/VDtUAZWH-LI/AAAAAAAAg88/SmKSrEHrS9Y/s1600/kibana%2B5.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-WEpHZBAbGDg/VDtUAZWH-LI/AAAAAAAAg88/SmKSrEHrS9Y/s1600/kibana%2B5.png" height="224" width="640" /></a></div><br /><br />Finally, because it's all stored in a full text search index, I can limit the data for any file or directory that contains the word "agile," but not "scrum." This really shows the power of the Elasticsearch/Kibana stack. It gives you the power of processing natural language (tokenizing, stemming) with the analytical insight of a business intelligence tool.<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-TVfn4EskxxQ/VDtVWr1JJJI/AAAAAAAAg9I/6srqEZiopyE/s1600/kibana%2B6.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-TVfn4EskxxQ/VDtVWr1JJJI/AAAAAAAAg9I/6srqEZiopyE/s1600/kibana%2B6.png" height="427" width="640" /></a></div><br /></div>